# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

SignalIdea (Saasfly) is an enterprise-grade Next.js SaaS boilerplate using a Turborepo monorepo architecture with full TypeScript support.

## Essential Commands

### Development
```bash
# Start all development servers
bun run dev

# Start web development only (recommended for most development)
bun run dev:web

# Start specific app development
cd apps/nextjs && bun with-env next dev
```

### Code Quality
```bash
# Run linting
bun run lint
bun run lint:fix  # Auto-fix

# Format code
bun run format
bun run format:fix  # Auto-fix

# Type checking
bun run typecheck
```

### Building & Testing
```bash
# Build all packages (excludes auth-proxy)
bun run build

# Build all packages including auth-proxy
bun run build:all

# Database operations
bun db:push  # Push schema changes

# Clean workspace
bun run clean

# Generate new components/packages
bun run gen

# View Tailwind CSS configuration (optional)
bun run tailwind-config-viewer  # Access at http://localhost:3333
```

## Architecture Overview

### Monorepo Structure
- **apps/nextjs**: Main Next.js 14 application with App Router
- **apps/auth-proxy**: Authentication proxy service
- **packages/api**: tRPC API layer with type-safe endpoints
- **packages/db**: Database schema (Kysely + Prisma)
- **packages/auth**: Authentication utilities (NextAuth.js/Clerk)
- **packages/stripe**: Payment integration
- **packages/ui**: Shared UI components (shadcn/ui based)
- **tooling/**: Shared configurations (ESLint, Prettier, TypeScript, Tailwind)

### Key Technical Stack
- **Frontend**: Next.js 14, React 18, TypeScript, Tailwind CSS, shadcn/ui, Framer Motion
- **Backend**: tRPC for APIs, Kysely for queries, Prisma for schema
- **Database**: PostgreSQL
- **Authentication**: Clerk (transitioning from NextAuth.js after June 2025)
- **Payments**: Stripe integration
- **State**: Zustand, React Query (TanStack Query)

### Important Patterns

#### API Development (tRPC)
All API endpoints are in `packages/api/src/router/`. The tRPC setup provides:
- End-to-end type safety
- Automatic TypeScript inference
- React Query integration

Example location: `packages/api/src/router/post.ts`

#### Database Queries
- Schema definitions: `packages/db/prisma/schema.prisma`
- Prisma generates Kysely types via `prisma-kysely` generator
- Type-safe queries using Kysely (not Prisma Client)
- Schema management: Update schema, then run `bun db:push`

#### Component Development
- Shared components: `packages/ui/src/`
- App-specific components: `apps/nextjs/src/components/`
- Use shadcn/ui patterns and Radix UI primitives
- Style with Tailwind CSS utilities

#### Authentication Flow
- Middleware: `apps/nextjs/src/middleware.ts`
- Auth config: `packages/auth/src/`
- Protected routes handled via middleware

### Environment Variables
Create `.env.local` in root (copy from `.env.example`):
- `NEXT_PUBLIC_APP_URL`: Application URL
- `POSTGRES_URL`: PostgreSQL connection string
- `NEXTAUTH_URL`, `NEXTAUTH_SECRET`: NextAuth configuration
- `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`, `CLERK_SECRET_KEY`: Clerk auth
- `GITHUB_CLIENT_ID`, `GITHUB_CLIENT_SECRET`: GitHub OAuth
- `STRIPE_API_KEY`, `STRIPE_WEBHOOK_SECRET`, `NEXT_PUBLIC_STRIPE_*_PRICE_ID`: Stripe payments
- `RESEND_API_KEY`, `RESEND_FROM`: Email service
- `NEXT_PUBLIC_POSTHOG_KEY`, `NEXT_PUBLIC_POSTHOG_HOST`: Analytics (optional)
- `ADMIN_EMAIL`: Admin account emails (comma-separated)

### Content Management
MDX content processed via Contentlayer2:
- Configuration: `apps/nextjs/contentlayer.config.ts`
- Content types: Docs, Guides, Blog Posts, Authors, Pages
- Location: `apps/nextjs/src/content/`

### Development Tips

#### Working with the Monorepo
- Changes in packages automatically reflect in apps during development
- Use `workspace:*` for internal package dependencies
- Turbo caches builds for efficiency

#### Adding New Features
1. API endpoints: Add to `packages/api/src/router/`
2. Database changes: Update schema in `packages/db/prisma/schema.prisma`, then run `bun db:push`
3. UI components: Add to `packages/ui/src/` for shared, or app-specific location
4. New pages: Create in `apps/nextjs/src/app/` following App Router conventions

#### Type Safety
- All API calls are fully typed through tRPC
- Database queries are type-safe via Kysely
- Use TypeScript strict mode throughout

### Common Tasks

#### Creating a New API Endpoint
1. Create router file in `packages/api/src/router/[name].ts`
2. Add router to `edgeRouter` in `packages/api/src/edge.ts`
3. The `edgeRouter` is exported from `packages/api/src/root.ts` as `appRouter`
4. Use in frontend via tRPC React Query hooks

Example routers: `auth.ts`, `customer.ts`, `stripe.ts`, `health_check.ts`, `k8s.ts`

#### Adding a New Database Table
1. Update `packages/db/prisma/schema.prisma`
2. Run `bun db:push` (from root or `packages/db/`)
3. Kysely types are auto-generated by `prisma-kysely` (output: `types.ts` and `enums.ts`)
4. Use generated types with Kysely query builder for type-safe queries

#### Implementing a New UI Component
1. Check if similar exists in `packages/ui/src/`
2. Follow shadcn/ui patterns with Radix UI
3. Use Tailwind CSS for styling
4. Add to `packages/ui/src/index.ts` for export

### Vercel Deployment

This project has a custom build setup for Vercel:
- Build command: `node build-for-vercel.js` (configured in `vercel.json`)
- The script sets default environment variables for CI builds
- Output directory: `apps/nextjs/.next`
- The build script automatically navigates to the correct directory and runs `bun run build:vercel`

When deploying to Vercel:
- Root directory can be set to repo root (build script handles navigation)
- Framework preset: Next.js
- Install command: `bun install`
- Build is configured to skip type checking and linting (handled in CI separately)

### Package Management

- Uses `bun` as package manager (v1.1.10+)
- Monorepo uses workspace protocol (`workspace:*`) for internal dependencies
- Post-install hook runs dependency version consistency checks
- Node.js 18+ required

### Important Notes

- **Auth transition**: Project uses Clerk by default. NextAuth.js implementation available in `feature-nextauth` branch
- **Environment wrapper**: Use `bun with-env` commands in app directories to load `.env.local` from root
- **MDX processing**: Build requires running `contentlayer2 build` before `next build`
- **Standalone output**: Next.js configured with `output: "standalone"` for optimized deployment
- **Type generation**: Database types auto-generated; don't manually edit `types.ts` or `enums.ts` in db package
- **Admin Dashboard**: Alpha feature available at `/admin/dashboard` - configure admin emails in `ADMIN_EMAIL` env var (comma-separated)