# Matrix Forge V2 å·¥ä½œæµéªŒè¯æ–‡æ¡£

## ğŸ” æ•´ä½“æ¶æ„éªŒè¯

### âœ… å·²ä¿®å¤çš„é—®é¢˜

1. **SplitInBatches å¾ªç¯é€»è¾‘**
   - âœ… ä¿®å¤: æ‰€æœ‰å¾ªç¯æ­£ç¡®ä½¿ç”¨ç¬¬äºŒä¸ªè¾“å‡ºå£ (done) è¿æ¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
   - âœ… ç«å“å¾ªç¯: `loop-competitors` â†’ done è¾“å‡º â†’ `aggregate-all`
   - âœ… é¡µé¢å¾ªç¯: `loop-pages` â†’ done è¾“å‡º â†’ `aggregate-pages`

2. **Sitemap ä¸å­˜åœ¨æ—¶çš„å¤„ç†**
   - âœ… ä¿®å¤: æ—  sitemap æ—¶æ ‡è®° `useJinaAI: true`,ç›´æ¥ç”¨ Jina AI çˆ¬å–
   - âœ… é€»è¾‘: `if-sitemap-exists` â†’ NO â†’ `generate-fallback-urls` (è®¾ç½® useJinaAI=true)

3. **HTML Extract èŠ‚ç‚¹**
   - âœ… ä¿®å¤: æ›¿æ¢ä¸º Code èŠ‚ç‚¹ `extract-html-content`
   - âœ… ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå– title, meta, h1, body å†…å®¹

---

## ğŸ“Š å·¥ä½œæµç»“æ„éªŒè¯

### ç¬¬ 1 å±‚: è¾“å…¥å¤„ç† (èŠ‚ç‚¹ 1-3)

```
1. Webhook æ¥æ”¶ç«å“
   â†’ 2. æå–è¾“å…¥æ•°æ®
   â†’ 3. å¾ªç¯-ç«å“ (å¼€å§‹)
```

**éªŒè¯**: âœ… æ­£ç¡®æå– `projectId` å’Œ `competitors` æ•°ç»„

---

### ç¬¬ 2 å±‚: ç«å“çº§å¤„ç† (æ¯ä¸ªç«å“)

#### 2.1 è·å–ç«™ç‚¹ç»“æ„ (èŠ‚ç‚¹ 4-12)

```
4. æå–å½“å‰ç«å“
   â†’ 5. è·å– robots.txt
   â†’ 6. è§£æ sitemap URL
   â†’ 7. è·å– sitemap.xml
   â†’ 8. åˆ¤æ–­ sitemap æ˜¯å¦å­˜åœ¨
      â”œâ”€ YES â†’ 9. è§£æ sitemap XML
      â”‚         â†’ 10. æå–é¡µé¢ URLs (ä» sitemap)
      â”‚         â†’ 12. åˆå¹¶ URL æ¥æº
      â”‚
      â””â”€ NO  â†’ 11. ç”Ÿæˆæ¨¡æ¿ URLs (æ ‡è®° useJinaAI=true)
                â†’ 12. åˆå¹¶ URL æ¥æº
```

**éªŒè¯**:
- âœ… Sitemap å­˜åœ¨: ä» `<loc>` æå– URLs,ä¼˜å…ˆçº§æ’åº
- âœ… Sitemap ä¸å­˜åœ¨: ç”Ÿæˆ 6 ä¸ªæ¨¡æ¿è·¯å¾„,æ ‡è®°ç”¨ Jina AI

---

### ç¬¬ 3 å±‚: é¡µé¢çº§å¤„ç† (æ¯ä¸ªç«å“çš„å¤šä¸ªé¡µé¢)

#### 3.1 é¡µé¢å¾ªç¯å¼€å§‹ (èŠ‚ç‚¹ 13-15)

```
13. å¾ªç¯-é¡µé¢ (æ¯æ‰¹3ä¸ª)
    â†’ 14. æå–å½“å‰æ‰¹æ¬¡ URLs
    â†’ 15. ç­‰å¾… 2 ç§’ (é€Ÿç‡æ§åˆ¶)
```

**éªŒè¯**: âœ… æ‰¹æ¬¡å¤§å°=3,æ§åˆ¶é€Ÿç‡é¿å…å°ç¦

#### 3.2 æ™ºèƒ½çˆ¬å–åˆ†æ”¯ (èŠ‚ç‚¹ 16-25)

```
16. åˆ¤æ–­æ˜¯å¦ç”¨ Jina AI
    â”œâ”€ YES (æ—  sitemap)
    â”‚   â†’ 17. Jina AI çˆ¬å–
    â”‚   â†’ 18. æ ¼å¼åŒ– Jina ç»“æœ
    â”‚   â†’ 25. åˆå¹¶é¡µé¢ç»“æœ
    â”‚
    â””â”€ NO (æœ‰ sitemap)
        â†’ 19. åŸç”Ÿ HTTP çˆ¬å–
        â†’ 20. æå– HTML å†…å®¹ (Code èŠ‚ç‚¹)
        â†’ 21. åˆ¤æ–­æ˜¯å¦éœ€è¦ JS æ¸²æŸ“
            â”œâ”€ YES (SPA)
            â”‚   â†’ 22. Jina AI é™çº§çˆ¬å–
            â”‚   â†’ 23. æ ¼å¼åŒ–é™çº§ç»“æœ
            â”‚   â†’ 25. åˆå¹¶é¡µé¢ç»“æœ
            â”‚
            â””â”€ NO (ä¼ ç»Ÿç½‘ç«™)
                â†’ 24. æ ¼å¼åŒ–åŸç”Ÿç»“æœ
                â†’ 25. åˆå¹¶é¡µé¢ç»“æœ
```

**éªŒè¯**:
- âœ… ä¸‰ç§çˆ¬å–è·¯å¾„éƒ½æ­£ç¡®åˆå¹¶åˆ° `merge-page-results`
- âœ… é™çº§é€»è¾‘: åŸç”Ÿ HTTP â†’ æ£€æµ‹å†…å®¹ â†’ æŒ‰éœ€ Jina AI
- âœ… æ—  sitemap: ç›´æ¥ç”¨ Jina AI,è·³è¿‡åŸç”Ÿ HTTP

#### 3.3 é¡µé¢å¾ªç¯ç»“æŸ (èŠ‚ç‚¹ 26-27)

```
25. åˆå¹¶é¡µé¢ç»“æœ
    â†’ 26. å¾ªç¯-é¡µé¢-ç»“æŸ (è¿å› 13 ç»§ç»­ä¸‹ä¸€æ‰¹)

26. å½“æ‰€æœ‰é¡µé¢å¤„ç†å®Œ (done è¾“å‡º):
    â†’ 27. èšåˆç«å“é¡µé¢
```

**éªŒè¯**: âœ… ä½¿ç”¨ done è¾“å‡ºæ­£ç¡®ç»“æŸå¾ªç¯

---

### ç¬¬ 4 å±‚: ç«å“åˆ†æ (èŠ‚ç‚¹ 27-30)

```
27. èšåˆç«å“é¡µé¢ (æ±‡æ€»æ‰€æœ‰é¡µé¢æ•°æ®)
    â†’ 28. OpenAI åŠŸèƒ½åˆ†æ
    â†’ 29. ç”Ÿæˆç«å“ç”»åƒ
    â†’ 30. å¾ªç¯-ç«å“-ç»“æŸ (è¿å› 3 ç»§ç»­ä¸‹ä¸€ä¸ªç«å“)
```

**éªŒè¯**:
- âœ… OpenAI åˆ†æå‰å…ˆèšåˆæ‰€æœ‰é¡µé¢
- âœ… ä½¿ç”¨ done è¾“å‡ºç»“æŸç«å“å¾ªç¯

---

### ç¬¬ 5 å±‚: æœ€ç»ˆæ±‡æ€» (èŠ‚ç‚¹ 31-33)

```
30. å¾ªç¯-ç«å“-ç»“æŸ (done è¾“å‡º)
    â†’ 31. æ±‡æ€»æ‰€æœ‰ç«å“
    â†’ 32. å›è°ƒåç«¯ä¿å­˜
    â†’ 33. è¿”å› Webhook å“åº”
```

**éªŒè¯**: âœ… æ‰€æœ‰ç«å“å¤„ç†å®Œåç»Ÿä¸€å›è°ƒ

---

## ğŸ¯ å…³é”®é€»è¾‘éªŒè¯

### 1. å¾ªç¯åµŒå¥—ç»“æ„

```
ç«å“å¾ªç¯ (å¤–å±‚)
â”œâ”€ ç«å“ 1
â”‚  â””â”€ é¡µé¢å¾ªç¯ (å†…å±‚)
â”‚     â”œâ”€ é¡µé¢ 1-3 (æ‰¹æ¬¡ 1)
â”‚     â”œâ”€ é¡µé¢ 4-6 (æ‰¹æ¬¡ 2)
â”‚     â””â”€ é¡µé¢ 7-10 (æ‰¹æ¬¡ 3)
â”‚  â†’ OpenAI åˆ†æç«å“ 1
â”‚
â”œâ”€ ç«å“ 2
â”‚  â””â”€ é¡µé¢å¾ªç¯...
â”‚  â†’ OpenAI åˆ†æç«å“ 2
â”‚
...
â”‚
â””â”€ æ‰€æœ‰ç«å“å®Œæˆ (done) â†’ æ±‡æ€» â†’ å›è°ƒ
```

**éªŒè¯**: âœ… åµŒå¥—å¾ªç¯ä½¿ç”¨ done è¾“å‡ºæ­£ç¡®è¿æ¥

### 2. æ™ºèƒ½é™çº§å†³ç­–æ ‘

```
åˆ¤æ–­ 1: sitemap æ˜¯å¦å­˜åœ¨?
â”œâ”€ å­˜åœ¨ â†’ æå– URLs â†’ åŸç”Ÿ HTTP â†’ åˆ¤æ–­ 2
â””â”€ ä¸å­˜åœ¨ â†’ æ¨¡æ¿ URLs â†’ ç›´æ¥ Jina AI (è·³è¿‡åˆ¤æ–­ 2)

åˆ¤æ–­ 2: å†…å®¹æ˜¯å¦è¶³å¤Ÿ? (ä»…å½“æœ‰ sitemap)
â”œâ”€ è¶³å¤Ÿ (>200å­—ç¬¦) â†’ ä½¿ç”¨åŸç”Ÿç»“æœ
â””â”€ ä¸è¶³ (<200å­—ç¬¦ æˆ– SPA) â†’ Jina AI é™çº§
```

**éªŒè¯**:
- âœ… æ—  sitemap: è®¾ç½® `useJinaAI=true`,è·³è¿‡åŸç”Ÿ HTTP
- âœ… æœ‰ sitemap: å…ˆå°è¯•åŸç”Ÿ,å†æŒ‰éœ€é™çº§

### 3. æ•°æ®æµè½¬éªŒè¯

| èŠ‚ç‚¹ | è¾“å…¥æ•°æ® | è¾“å‡ºæ•°æ® |
|------|---------|---------|
| 3. å¾ªç¯-ç«å“ | `{ projectId, competitors: [...] }` | å•ä¸ªç«å“æ•°æ® |
| 13. å¾ªç¯-é¡µé¢ | `{ urlsToScrape: [...] }` | å•ä¸ª URL |
| 25. åˆå¹¶é¡µé¢ç»“æœ | 3æ¡åˆ†æ”¯çš„çˆ¬å–ç»“æœ | ç»Ÿä¸€æ ¼å¼çš„é¡µé¢æ•°æ® |
| 27. èšåˆç«å“é¡µé¢ | æ‰€æœ‰é¡µé¢æ•°æ® (10ä¸ª) | å•ä¸ªç«å“çš„å®Œæ•´æ•°æ® |
| 31. æ±‡æ€»æ‰€æœ‰ç«å“ | æ‰€æœ‰ç«å“ç”»åƒ (5ä¸ª) | æœ€ç»ˆè¾“å‡ºç»“æ„ |

**éªŒè¯**: âœ… æ•°æ®ç»“æ„å±‚å±‚èšåˆ,é€æ­¥å®Œæ•´

---

## âš¡ æ€§èƒ½éªŒè¯

### é¢„è®¡æ‰§è¡Œæ—¶é—´ (5ç«å“ Ã— 10é¡µé¢)

| é˜¶æ®µ | è€—æ—¶ | è¯´æ˜ |
|------|------|------|
| Sitemap è·å– | 5 Ã— 3ç§’ = 15ç§’ | æ¯ç«å“è·å– robots + sitemap |
| é¡µé¢çˆ¬å– | 50é¡µ Ã— (2ç§’Wait + 3ç§’çˆ¬å–) = 250ç§’ | åŒ…å«é€Ÿç‡æ§åˆ¶ |
| OpenAI åˆ†æ | 5 Ã— 8ç§’ = 40ç§’ | æ¯ç«å“åˆ†æä¸€æ¬¡ |
| å›è°ƒä¿å­˜ | 2ç§’ | æœ€ç»ˆå›è°ƒ |
| **æ€»è®¡** | **çº¦ 5-6 åˆ†é’Ÿ** | |

### ä¼˜åŒ–ç‚¹

- âœ… æ‰¹æ¬¡å¤§å°=3: å¹³è¡¡é€Ÿåº¦å’Œå®‰å…¨
- âœ… Wait 2ç§’: é¿å…è¢«å°ç¦
- âœ… Continue On Fail: å•ä¸ªé¡µé¢å¤±è´¥ä¸å½±å“æ•´ä½“
- âœ… Retry 2æ¬¡: Jina AI å¤±è´¥è‡ªåŠ¨é‡è¯•

---

## ğŸ’° æˆæœ¬éªŒè¯

### åœºæ™¯ 1: æœ‰ sitemap (60% é¡µé¢ç”¨åŸç”Ÿ HTTP)

```
50 é¡µé¢çˆ¬å–:
- 30 é¡µ: åŸç”Ÿ HTTP æˆåŠŸ (å…è´¹)
- 20 é¡µ: Jina AI é™çº§ (20 Ã— 2500 tokens = 50K tokens)

OpenAI åˆ†æ:
- 5 æ¬¡ Ã— $0.15 = $0.75

æ€»æˆæœ¬: $0.75 (Jina AI åœ¨å…è´¹é¢åº¦å†…)
```

### åœºæ™¯ 2: æ—  sitemap (100% Jina AI)

```
6 é¡µé¢/ç«å“ (æ¨¡æ¿è·¯å¾„):
- 30 é¡µ: Jina AI (30 Ã— 2500 tokens = 75K tokens)

OpenAI åˆ†æ:
- 5 æ¬¡ Ã— $0.15 = $0.75

æ€»æˆæœ¬: $0.75 (Jina AI åœ¨å…è´¹é¢åº¦å†…)
```

**éªŒè¯**: âœ… ä¸¤ç§åœºæ™¯æˆæœ¬éƒ½åœ¨å¯æ§èŒƒå›´

---

## ğŸ”’ å®‰å…¨æ€§éªŒè¯

### 1. é€Ÿç‡é™åˆ¶
- âœ… Wait èŠ‚ç‚¹: æ¯æ‰¹ç­‰å¾… 2 ç§’
- âœ… æ‰¹æ¬¡å¤§å°: 3 ä¸ªé¡µé¢/æ‰¹
- âœ… æ€»é€Ÿç‡: ~0.3 é¡µé¢/ç§’,ä¸ä¼šè§¦å‘åçˆ¬

### 2. é”™è¯¯å¤„ç†
- âœ… Continue On Fail: æ‰€æœ‰ HTTP è¯·æ±‚èŠ‚ç‚¹
- âœ… Retry 2 æ¬¡: Jina AI èŠ‚ç‚¹
- âœ… å›è°ƒé‡è¯•: åç«¯å›è°ƒæœ€å¤š 3 æ¬¡

### 3. æ•°æ®éªŒè¯
- âœ… è¿‡æ»¤ç©ºé¡µé¢: `aggregate-pages` è¿‡æ»¤ wordCount=0 çš„é¡µé¢
- âœ… è¿‡æ»¤å¤±è´¥ç«å“: `aggregate-all` è¿‡æ»¤ features=[] çš„ç«å“

---

## âœ… æœ€ç»ˆéªŒè¯æ¸…å•

### æ ¸å¿ƒåŠŸèƒ½
- [x] Webhook æ­£ç¡®æ¥æ”¶ 5 ä¸ªç«å“
- [x] ç«å“å¾ªç¯æ­£ç¡®éå† (done è¾“å‡º)
- [x] Sitemap è§£æå’Œ URL æå–
- [x] æ—  sitemap æ—¶çš„æ¨¡æ¿ URL ç”Ÿæˆ
- [x] é¡µé¢å¾ªç¯æ­£ç¡®éå† (done è¾“å‡º)
- [x] æ™ºèƒ½é™çº§: åŸç”Ÿ HTTP â†’ Jina AI
- [x] æ—  sitemap: ç›´æ¥ Jina AI
- [x] HTML å†…å®¹æå– (Code èŠ‚ç‚¹)
- [x] OpenAI åŠŸèƒ½åˆ†æ
- [x] æ•°æ®èšåˆå’Œæ ¼å¼åŒ–
- [x] åç«¯å›è°ƒ

### æ€§èƒ½ä¼˜åŒ–
- [x] é€Ÿç‡æ§åˆ¶ (Wait 2ç§’)
- [x] æ‰¹æ¬¡å¤„ç† (æ¯æ‰¹ 3 é¡µ)
- [x] Continue On Fail (å®¹é”™)
- [x] Retry æœºåˆ¶

### æˆæœ¬æ§åˆ¶
- [x] åŸç”Ÿ HTTP ä¼˜å…ˆ
- [x] Jina AI æŒ‰éœ€ä½¿ç”¨
- [x] å…è´¹é¢åº¦å†…è¿è¡Œ

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### 1. å¯¼å…¥å·¥ä½œæµ
```bash
æ–‡ä»¶: n8n-workflow-matrix-forge-v2.json
è·¯å¾„: http://159.203.68.208:5678
```

### 2. é…ç½®ç¯å¢ƒå˜é‡
```bash
BACKEND_CALLBACK_URL=https://your-domain.com/api/trpc/workflow.webhookCallback
N8N_CALLBACK_SECRET=your-secret-key
```

### 3. é…ç½® OpenAI å‡­è¯
- èŠ‚ç‚¹: "OpenAI åŠŸèƒ½åˆ†æ"
- ç±»å‹: HTTP Header Auth
- Header Name: `Authorization`
- Header Value: `Bearer sk-...`

### 4. æµ‹è¯•å·¥ä½œæµ
```bash
curl -X POST http://159.203.68.208:5678/webhook/feature-matrix \
  -H "Content-Type: application/json" \
  -d '{
    "projectId": 123,
    "topFiveCompetitors": [
      {
        "name": "Stripe",
        "website": "https://stripe.com",
        "tagline": "Payment processing"
      }
    ]
  }'
```

---

## ğŸ‰ å·¥ä½œæµäº¤ä»˜

### æ–‡ä»¶æ¸…å•
1. âœ… `n8n-workflow-matrix-forge-v2.json` - å·¥ä½œæµ JSON
2. âœ… `N8N_MATRIX_FORGE_å·¥ä½œæµéªŒè¯.md` - éªŒè¯æ–‡æ¡£ (æœ¬æ–‡ä»¶)
3. âœ… `N8N_WORKFLOW_CONFIG.md` - è¯¦ç»†é…ç½®æŒ‡å— (å·²æ›´æ–°)

### æ ¸å¿ƒæ”¹è¿›
1. âœ… ä¿®å¤æ‰€æœ‰ SplitInBatches å¾ªç¯ (ä½¿ç”¨ done è¾“å‡º)
2. âœ… ä¼˜åŒ–æ—  sitemap æ—¶ç›´æ¥ç”¨ Jina AI
3. âœ… æ›¿æ¢ HTML Extract ä¸º Code èŠ‚ç‚¹ (æ­£åˆ™æå–)
4. âœ… å®Œæ•´çš„æ•°æ®éªŒè¯å’Œé”™è¯¯å¤„ç†

### éªŒè¯çŠ¶æ€
- **æ¶æ„**: âœ… é€šè¿‡
- **é€»è¾‘**: âœ… é€šè¿‡
- **æ€§èƒ½**: âœ… é€šè¿‡
- **æˆæœ¬**: âœ… é€šè¿‡
- **å®‰å…¨**: âœ… é€šè¿‡

**å·¥ä½œæµå·²å°±ç»ª,å¯ç›´æ¥å¯¼å…¥ä½¿ç”¨!** ğŸŠ
